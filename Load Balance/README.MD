Load Balance com Site Armazenado no Apache

-Objetivo

Neste laborat√≥rio ser√° configurado um balanceamento de carga (Load Balance) utilizando o Nginx como balanceador e dois servidores Apache hospedando o mesmo site.
Al√©m disso, haver√° uma VM cliente respons√°vel pelos testes de acesso e valida√ß√£o do balanceamento.

-Estrutura do Laborat√≥rio

M√°quinas Virtuais Utilizadas: 

Descri√ß√£o:

--Servidor Apache 1: Ubuntu 192.168.100.50 - Site principal

--Servidor Apache 2: Ubuntu 192.168.100.52 - Clone do site principal

--Balanceador: Nginx 192.168.100.53 - Respons√°vel pelo Load Balance

--Cliente: Lubuntu 192.168.100.51 - Usado para valida√ß√£o de funcionamento

Redes configuradas no VirtualBox:

--Rede Interna: teste

--Rede NAT: sa√≠da para a internet (para atualiza√ß√µes e downloads)

Cada VM possui duas interfaces de rede:

‚Äî Rede interna (192.168.100.0/24)

‚Äî Rede NAT (acesso externo)

-Etapas de Configura√ß√£o

 1. Cria√ß√£o das VMs

Foi criada uma VM Ubuntu com o Apache e o site local configurado (j√° existe uma documenta√ß√£o sobre esse lab, mas ainda n√£o est√° no github).
Em seguida, essa VM ser√° clonada para servir como o segundo servidor Apache.

Tamb√©m foram criadas mais duas VMs:

--Uma para o Nginx (Load Balance)

--Outra para o cliente (Lubuntu)

Ap√≥s isso, todas as VMs foram inicializadas no VirtualBox.

![VM](../Assets/virtualbox/vms_virtualbox.png)

 2. Configura√ß√£o de Rede VM clone

Inicialmente, foi configurada a interface de rede interna nas quatro VMs, permitindo a comunica√ß√£o entre elas.
Tamb√©m foi adicionada uma interface NAT na VM clone para permitir acesso √† internet (para atualiza√ß√µes e instala√ß√£o de pacotes).

IPs definidos manualmente via Netplan:

![YAML](../Assets/yaml/file_yaml_clone.png)

Problemas Encontrados

Durante a configura√ß√£o da VM clonada (Apache 2), foram observados problemas de conectividade.

Falha 1 ‚Äî Interface NAT sem IP

Mesmo com o arquivo YAML configurado, a interface NAT (enp0s8) n√£o recebia IP automaticamente.
Foi necess√°rio atribuir manualmente um IP com:

sudo dhclient enp0s8

O IP obtido foi 10.0.3.15.

![DHCLIENT](../Assets/Utilitarios/dhclient_manual.png)

Falha 2 ‚Äî Sem acesso √† internet

Mesmo ap√≥s receber o IP manualmente, a m√°quina n√£o conseguia sair para a internet.

Testes de ping:

ping 8.8.8.8

![PING](../Assets/Utilitarios/ping_failed.png)

An√°lises e Diagn√≥stico

O VirtualBox normalmente atribui o NAT √† primeira interface de rede.
Por isso, foi necess√°rio inverter a ordem das interfaces (pois a interface com NAT era o adaptador 2 e a interface de rede interna era o adptador 1), nas configura√ß√µes da VM e ajustar o arquivo YAML correspondente.

interfaces invertidas no VirtualBox

![ADP2](../Assets/virtualbox/adaptador2_nat.png)

![ADP1](../Assets/virtualbox/adaptador1_nat.png)

arquivo YAML corrigido

![INVERSAO](../Assets/yaml/inversao_arquivo_yaml.png)

Mesmo ap√≥s o ajuste, ao verificar com:

cat /etc/netplan/*.yaml

O systemd-networkd ainda aplicava apenas a configura√ß√£o da primeira interface (a est√°tica).

Verifica√ß√£o:

![CAT](../Assets/yaml/cat_etc-netplan-yaml.png)

Causa Raiz

Foi identificado que o gateway configurado manualmente no arquivo YAML estava conflitando com o DHCP da interface NAT.

O arquivo possu√≠a algo como:

gateway4: 192.168.100.5

Esse gateway n√£o existia, e isso causava confus√£o ao systemd-networkd, impedindo a aplica√ß√£o correta das configura√ß√µes.

Solu√ß√£o Aplicada

A solu√ß√£o foi remover o gateway manual e deixar o DHCP fornecer automaticamente o IP e gateway padr√£o.
Ap√≥s isso, as configura√ß√µes foram aplicadas corretamente.

![AJUSTE](../Assets/yaml/ajuste_gateway.png)

Erro ao aplicar Netplan

Ao executar:

sudo netplan apply

Foi exibido o erro:

![WARNING](../Assets/Utilitarios/warning.png)

Isso ocorreu porque as duas interfaces estavam sendo declaradas no mesmo arquivo YAML, gerando conflito de identa√ß√£o.

Corre√ß√£o

Foram criados dois arquivos separados:

/etc/netplan/02-enp0s3.yaml ‚Üí Interface NAT (DHCP autom√°tico)

/etc/netplan/01-enp0s8.yaml ‚Üí Interface de rede interna (IP est√°tico)

Ap√≥s dividir os arquivos, as configura√ß√µes foram aplicadas com sucesso e o acesso √† internet foi restaurado.

![APLICACAO](../Assets/yaml/aplication_yaml_available.png)

Resultado Final

Conectividade interna entre as VMs funcionando.

![COMUNICACAO](../Assets/Utilitarios/vms_comunication.png)

Conectividade externa via NAT funcional.

![INTERNET](../Assets/Utilitarios/saida_internet_available.png)

Sistema pronto para configura√ß√£o do Nginx como Load Balancer nas pr√≥ximas etapas.

üóÇÔ∏è Estrutura de Arquivos Netplan (Exemplo Final)

/etc/netplan/

‚îú‚îÄ‚îÄ 01-enp0s8.yaml   # Rede interna - IP est√°tico (192.168.100.52)

‚îî‚îÄ‚îÄ 02-enp0s3.yaml   # Rede NAT - DHCP autom√°tico
